#!/bin/bash

set -Ceu

EXT="(JPG|jpg|jpeg|PNG|png|TIFF|TIF|tiff|tif|CR2|NEF|ARW|MOV|mov|AVI|avi)"

function _replace_space_to_underbar() {

    # $1: file
    function _exec() {
        new_file=$(echo ${file} | sed 's/ /_/g' | sed 's/ã€€/_/g')
        new_dir=$(dirname ${new_file})
        dir=$(dirname ${file})
        [ ! -e ${new_dir} ] && {
            mkdir ${new_dir}
            mv $(find ${dir} -mindepth 1) ${new_dir} 2>&1 > /dev/null
            [ $(find ${dir} -mindepth 1 | wc -l) -eq 0 ] && {
                rm -rf "${dir}"
            }
        }
        mv -n "${file}" "${new_file}"
        echo "${new_file}"
    }

    for file in $@; do
        if [ -d "$1" ]; then
            for file in $(find $1 -mindepth 1 -type f); do
                _exec "${file}"
            done
        elif [ -e "$1" ]; then
            _exec "${file}"
        fi
        shift
    done
}

STASH_IFS=${IFS}
IFS=$'\n'
if [ -p /dev/stdin ]; then
    _replace_space_to_underbar $(cat -)
else
    _replace_space_to_underbar "$@"
fi
IFS=${STASH_IFS}
