<?php namespace App\Services;

use HTTP\Request;

class Downloader {

	private $json = '';

	// 対象ディレクトリの作成
	//echo '$info[\'img_dir\'] = '.$info['img_dir'].'<br>';
	//if( !is_dir( $info['img_dir'] ) ) {
	//	makeDir( $info['img_dir'] );
	//}

	public function fetch($info) {
		// 各カウンタの初期化
		$page_count		= 0;
		$oppai_count	= 0;
		$newimgcount	= 0;

		// https://datamarket.azure.com/ > マイアカウント
		$accountKey = '0lg92hbP93ZoCA2h1lSX/iUnnE2OjFYX0VIVLLHugZw=';

		//while( $page_count <= $info['number'] ) {	 // 1ページあたり 50 枚
			$offset = $page_count * 50;
			$url = "https://api.datamarket.azure.com/Bing/Search/Image?"
				//					.'&Version=2.2'
				//					.'&Sources=Image'
				."Query='".urlencode( $info['kw'] )."'"
		//		."&Market='".$info['region']."'"
				."&Adult='off'"
				."&\$format=json"
				."&\$top=50&\$skip=".$offset;

			// リクエストの発行
			$context = stream_context_create(array('http' => array(
				'request_fulluri' => true,
				'header' => "Authorization: Basic ".base64_encode($accountKey.":".$accountKey )
			)
		));
			//} //end of while

		echo $url.'<br>';

		$this->json = file_get_contents( $url, 0, $context );
		$this->json = file_get_contents( $url, 0, $context );
		//	$ref = json_decode( $res );
		//	$arr = $ref -> d -> results;
		//	if ( !isset( $arr ) ) { // Resultsが定義されていない場合
		//		break;
		//	}
	}

	public function getJson(){
		return $this->json;
	}
}

?>

