<?php

// --------------------------------------------------------------
// class FeedList
// --------------------------------------------------------------
class FeedList {

	public function FeedList( $db ) {

		try {
			$stmt = $db->prepare( "SELECT * FROM rss_feeds" );
			$stmt->execute();
			$feeds = $stmt->fetchAll();
			foreach( $feeds as $feed ) {
				$this->feeds[] = new Feed(	$db, 
											$feed['rss_feed_id'],
											$feed['url'],
											$feed['name'],
											$feed['last_update']
								 );
			}
		} catch ( PDOException $e ){
			var_dump( $e->getMessage() );
		}
	}

	public function get_feeds() {
		return $this->feeds;
	}

	public function fetch( $db ) {
		foreach( $this->feeds as $feed ) {
			$last_post_date = $feed->fetch( $db );
			if( $last_post_date != '' && strtotime( $last_post_date ) > strtotime( $last_update ) ) {
//				echo 'START FeedList::UPDATE_last_update()';
					$stmt = $db->prepare( "UPDATE `rss_feeds` SET `last_update` = :time WHERE `rss_feed_id` = :rss_feed_id" );
			        $stmt->bindValue(':time', date('Y-m-d H:i:s', strtotime($last_post_date) ) );
			        $stmt->bindValue(':rss_feed_id', $feed->get_value('rss_feed_id') );
					$stmt->execute();
//				echo '　　OK<br>'."\n";
			}
		}
	}
}
?>


